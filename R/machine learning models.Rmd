---
title: "Machine learning models"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
.figure {
   margin-top: 25px;
   margin-bottom: 10px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
# options(gtsummary.print_engine = "gt")
# options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```


```{r library}
library(tidyverse)
library(tidymodels)
library(themis)
```


```{r load}
omics_data <- read_delim(paste0(here::here(), "/lusq_reprocess_2021-12-08_iron_log2_merged.txt")) %>% 
  janitor::clean_names()
metabolites_data <- read_delim(paste0(here::here(), "/hmdb_keep_columns.txt")) %>% 
  janitor::clean_names()
```

```{r data prep}
# Imputation
omics_data <- omics_data %>% 
  mutate(across((starts_with("x06")), .fns = ~ replace_na(., min(., na.rm = TRUE))))

mldata <- omics_data %>% 
  # Filter identified metabolites
  filter(non_heavy_identified_flag == 1 & !is.na(hmdb) & !str_detect(hmdb, "\\|")) %>% 
  # Join with known metabolites
  inner_join(., metabolites_data %>% 
              select(accession, taxonomy_super_class),
            by = c("hmdb" = "accession")) %>% 
  filter(!is.na(taxonomy_super_class))

test_data <- omics_data %>% 
  # Filter identified metabolites
  filter(non_heavy_identified_flag != 1) %>% 
  select(hmdb, starts_with("x06"))
```

# Data exploration

# Build a model
I use the whole identified metabolites data as a traning set and will use 10 fold cross validation to evaluate the performance of the models.  

```{r}
# Explore what will need to be changed
skimr::skim(mldata)

train_data <- mldata %>% 
  select(hmdb, starts_with("x06"), taxonomy_super_class) %>% 
  group_by(taxonomy_super_class) %>% 
  mutate(number_sample_class = n()) %>% 
  ungroup() %>% 
  filter(number_sample_class > 5) %>% 
  select(-number_sample_class) %>% 
  mutate_if(is.character, factor)

skimr::skim(train_data)
summary(train_data)
```

## Build a recipe

```{r recipe}
# Recipe : data pre processing and features engineering + imputation
mldata_recipe <-
  # 1.model formula
  recipe(taxonomy_super_class ~ ., data = train_data)  %>% 
  # 2.keep these variables but not use them as either outcomes or predictors
  update_role(hmdb, new_role = "ID") %>% 
  # Use nearest neighbor to create new synthetic observation almost similar
  step_smote(taxonomy_super_class)
mldata_recipe
```

- 10 fold cross validation
```{r}
set.seed(123)
mldata_folds <- vfold_cv(train_data, strata = taxonomy_super_class)
```

## Build model

# RANDOM FOREST
```{r rand_forest}
set.seed(345)
# Model specification
ranger_spec <- rand_forest(
  mtry = tune(), 
  min_n = tune(),
  trees = 1000) %>% 
  set_mode("classification") %>% 
  set_engine("ranger")

# Set up a workflow container
ranger_workflow <- 
  workflow() %>% 
  # Add preprocessor
  add_recipe(mldata_recipe) %>%
  add_model(ranger_spec)

# Tuning
doParallel::registerDoParallel()
set.seed(678)
ranger_tune <-
  tune_grid(ranger_workflow, 
            resamples = mldata_folds, 
            grid = 20) # Try the 20 candidate point with each min_n and mtry
```

# Visualize tuned parameters
```{r Explore Tuning Results }
ranger_tune %>%
  collect_metrics() %>%
  filter(.metric == "roc_auc") %>%
  select(mean, min_n, mtry) %>%
  pivot_longer(min_n:mtry,
               values_to = "value",
               names_to = "param") %>%
  ggplot(aes(value, mean, color = param)) +
  geom_point(show.legend = FALSE) +
  facet_wrap( . ~ param, scales = "free_x")

# # Tune more
# new_grid <- grid_regular(
#   mtry(range = c(70, 80)),
#   min_n(range = c(0, 4)),
#   levels = 10
# )
# set.seed(678)
# sec_tune_results <- tune_grid( 
#   ranger_workflow, 
#   resamples = mldata_folds, 
#   grid = new_grid
# )
# sec_tune_results %>% collect_metrics() %>%
#   filter(.metric == "roc_auc") %>%
#   mutate(min_n = factor(min_n)) %>%
#   ggplot(aes(mtry, mean, color = min_n)) +
#   geom_line(alpha = 0.5, size = 1.5) +
#   geom_point()

# Finalize the model with our tuned parameters
set.seed(789)
final_rf <- ranger_workflow %>% 
  finalize_workflow(select_best(ranger_tune, "roc_auc"))
final_rf
```
<br>



***

```{r Performance Metrics}
set.seed(789)
rf_results <- final_rf %>% 
  fit_resamples( 
    resamples = mldata_folds,
    metrics = metric_set(roc_auc, accuracy, sensitivity, specificity),
    control = control_resamples(save_pred = TRUE, verbose = TRUE)
  )
```


# Evaluate models
```{r evaluate models}
# Explore Performance Metrics
collect_metrics(rf_results)
```
Acuuracy and roc-auc show a really good performance. The sensitivity and specificity are high.

```{r evaluate models}
rf_results %>%
  collect_predictions() %>%
  conf_mat(taxonomy_super_class, .pred_class)

rf_results %>%
  collect_predictions() %>%
  group_by(id) %>%
  roc_curve(.pred_class, `.pred_Lipids and lipid-like molecules`) %>%
  autoplot()

rf_results %>% 
  collect_metrics() %>% 
  mutate(model = "rf") %>% 
  ggplot(aes(x= .metric, y=mean))+
  geom_bar(stat = "identity",
           position = position_dodge())+
  geom_errorbar(aes(x = .metric,
                    ymin = mean - std_err,
                    ymax = mean + std_err),
                width = 0.2, alpha = 0.5,
                position=position_dodge(width=0.9))+
  theme_minimal()+
  scale_fill_viridis_d(option = "A")
```
<br>
<br>

```{r evaluate models2}
rf_results %>% 
  conf_mat_resampled()

# Visualization
rf_results %>% 
  collect_predictions() %>% 
  conf_mat(truth = taxonomy_super_class , estimate = .pred_class) %>% 
  autoplot()+
  ggtitle("Random forest")

# rf_results %>% 
#   collect_predictions() %>% 
#   ggplot(aes(x=taxonomy_super_class, y=.pred_class))+
#   geom_tile()

df <- rf_results %>% 
  collect_predictions()
conf_tab <- table(df$taxonomy_super_class, df$.pred_class)
conf_tab <- conf_tab / rowSums(conf_tab)
conf_tab <- as.data.frame(conf_tab, stringsAsFactors = TRUE)
conf_tab$Var2 <- factor(conf_tab$Var2, rev(levels(conf_tab$Var2)))

ggplot(tab, aes(Var1, Var2, fill = Freq)) +
  geom_tile() +
  geom_text(aes(label = scales::percent(Freq))) +
  scale_fill_gradient(low = "white", high = "#3575b5")+
  labs(x = "Truth", y = "Prediction", title = "Confusion matrix",
       fill = "Valid prediction")+
  theme_minimal()

rf_results %>%
  collect_predictions() %>%
  mutate(correct = case_when(
    taxonomy_super_class == .pred_class      ~ "correct predictions",
    TRUE                                     ~ "incorrect predictions"
  )) %>% 
  ggplot(aes(x=taxonomy_super_class, fill = correct))+
  geom_bar(position = position_dodge(preserve = "single"))+
  coord_flip()

# Calculate prediction after the fact
rf_results %>% collect_predictions() %>%
  ppv(truth = taxonomy_super_class, estimate = .pred_class)
```
<br>

***

# Prediction
```{r fit on testing RF}
############################################################################################### AT LAST
# Step finalize Fit : fitting to the whole training and evaluating on the testing data
# With the model of our choice
set.seed(789)
last_fit <- final_rf %>% 
  fit(train_data)

test_fit <- last_fit %>% 
  predict(test_data)

predicted_metabolites <- test_data %>% 
  bind_cols(., test_fit) %>% 
  rename(taxonomy_super_class = .pred_class) %>% 
  mutate(pred = "prediction") %>% 
  bind_rows(., train_data %>% 
              mutate(pred = "measured")) %>% 
  left_join(., omics_data %>% 
              select(row_id, row_m_z, row_retention_time,
                     hmdb),
            by = "hmdb")

predicted_metabolites %>% 
  ggplot(aes(x=row_m_z, row_retention_time, color= pred))+
  geom_point()+
  facet_wrap(. ~ taxonomy_super_class)


```


<br>







